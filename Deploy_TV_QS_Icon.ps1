<#
    .Description
    This powershell script will create a shortcut (.lnk or .url) with a custom icon that is generated by using the Base64 embedded string within the script (no icon file required).  This allows you to create Platform scripts to deploy shortcuts to Windows Devices in Intune, instead of having to package as Win32 apps.  Just keep in mind Platform script run once, unless they are changed.  

    Inspired By and Assistance from:  https://community.spiceworks.com/t/powershell-shortcut-with-custom-embedded-icon/808892
    
    Removing Shortcuts
    -------------------
    If you need to delete shortcuts modify this script Action variable to "Remove", upload the script, make note in the Intune description when you set to delete, and leave the assignments in place.  Plan to fully delete the Platform script in 6 months down the road, this give your computers time to run the script and cleanup the shortcut.

    Adjusting URL
    ----------------
    If you just need to update the URL only, set the Action variable to "Add", adjust the ShortcutUrl variable, and then upload the script.  It will run one time again since a new script was uploaded.

    Changing Shortcut Name
    ------------------------
    If you just need to update the Name of the shortcut, you will need to make a new Platform script, and go through the "Removing Shortcuts" section above.

    Adjusting the Desktop shortcut folder location (ex. Putting shortcut in sub folder on desktop)
    ---------------------------------------------------------------------------------------------------
    Adjust the "Desktop" variable as needed, but make sure to keep the "$([Environment]::GetFolderPath("Desktop"))" see below in comments for how to add a sub folder if required.  If removing a shortcut and the sub folder is empty after deleting of the shortcut it will delete the sub folder.

    Turning off icon
    ----------------------
    You may not want to have an icon file, if not adjust the "EnableIcon" variable to $False.  Use the commented out line.

    Step by Step
    ---------------------------
    Step 1:  Create or locate an .ICO file, if needed convert an image to ICO using https://convertio.co/jpg-ico/
    Step 2:  Upload the .ICO file to https://base64.guru/converter/encode/image/ico and then copy the Base64 text and replace it below in the $IconBase64 variable
    Step 3:  Choose the Action values are either "Add" or "Remove"
    Step 4:  Adjust the "ShortcutName".
    Step 5:  Adjust the "ShortcutPath".
    Step 6:  Adjust the "ShortcutType" to either .url or .lnk.
    Step 7:  Adjust the "Desktop" path you want the shortcut to be located.  Recommended to keep default, see notes.
    Step 8:  Adjust the "EnableIcon" to $True or $False depending if you want an icon or not.
    Step 9:  Create a Platform Script to push out the shortcuts.
#>

#
##
#START - Variables To Adjust
#Choose either Add or Remove. Comment out line as needed.
[System.String]$Action = "Add"
#[System.String]$Action = "Remove"

[system.string]$ShortcutName = "Support Meanquest"
[system.string]$ShortcutPath = "C:\ProgramData\Meanquest\Support Meanquest.exe"

#Choose .url for website shortcuts, Choose .lnk for linking to applications, local resources, or files.  Comment out line as needed.
#[system.string]$ShortcutType = ".url"
[system.string]$ShortcutType = ".lnk"

#Enable or Disable the Icon
[System.String]$EnableIcon = $True
#[System.String]$EnableIcon = $False

#The Desktop path of $([Environment]::GetFolderPath("Desktop")) will return the desktop folder.  If a users is redirecting to OneDrive it will return "C:\Users\username\OneDrive\Desktop" if not it will return "C:\Users\username\Desktop".  Do not change this portion or hardcode it (ex. C:\User\username\desktop), let the environment variables sort it out.
#Comment line out as needed
[system.string]$Desktop = "$([Environment]::GetFolderPath("Desktop"))"

#If you need to put a shortcut into a Sub folder see the below example.  Please note the folder will be delete if the Action is set to "Remove" only if it is empty.  Also don't name the subfolder "Desktop" otherwise it won't delete as there is logic to prevent the root Desktop from being deleted if empty.
#Comment line out as needed
#[system.string]$Desktop = "$([Environment]::GetFolderPath("Desktop"))\Test"

#If you need to put a shortcut on the computer for all users then.  Adjust the Platform Script to run as system for this to work properly.
#[system.string]$Desktop = "C:\Users\Public\Desktop"

#END - Variables To Adjust
##
#
#
##
#START - DO NOT MODIFY
#Icon is dropped in the root of the user profile folder.
[System.String]$IconPath = "$env:USERPROFILE\$ShortcutName.ico"
#END - DO NOT MODIFY
##
#
#
##
#START - Variables To Adjust
#Below is the Icon Base64, replace the existing with what you have generated after uploading your icon to the website mentioned.
[system.string]$IconBase64 = "AAABAAEAICAAAAEAIACoEAAAFgAAACgAAAAgAAAAQAAAAAEAIAAAAAAAABAAAAAAAAAAAAAAAAAAAAAAAABRIwr/USMK/1EjCv9RIwr/USMK/1EjCv9RIwr/USMK/1EjCv9RIwr/USMK/1EjCv9RIwr/USMK/1EjCv9RIwr/USMK/1EjCv9RIwr/USMK/1EjCv9RIwr/USMK/1EjCv9RIwr/USMK/1EjCv9RIwr/USMK/1EjCv9RIwr/USMK/1EjCv9RIwr/USMK/1EjCv9RIwr/USMK/1EjCv9RIwr/USMK/1EjCv9RIwr/USMK/1EjCv9RIwr/USMK/1EjCv9RIwr/USMK/1EjCv9RIwr/USMK/1EjCv9RIwr/USMK/1EjCv9RIwr/USMK/1EjCv9RIwr/USMK/1EjCv9RIwr/USMK/1EjCv9RIwr/USMK/1EjCv9RIwr/USMK/1EjCv9QIQj/Th8G/04fBv9OHwb/Th8G/04fBv9OHwb/Th8G/04fBv9OHwb/Th8G/04fBv9OHwb/Th8G/04fBv9QIQj/USMK/1EjCv9RIwr/USMK/1EjCv9RIwr/USMK/1EjCv9RIwr/USMK/1EjCv9RIwr/USMK/1EjCv9RIwr/UCII/2lCLf+Qc2X/kHNl/5BzZf+Qc2X/kHNl/5BzZf+Qc2X/kHNl/5BzZf+Qc2X/kHNl/5BzZf+Qc2X/kHNl/2tEMP9QIgj/USMK/1EjCv9RIwr/USMK/1EjCv9RIwr/USMK/1EjCv9RIwr/USMK/1EjCv9RIwr/USMK/1EjCv9OHwb/k3dq//7+///+/v///v7///7+///+/v///v7/////////////////////////////////////////////mX1x/04fBv9RIwr/USMK/1EjCv9RIwr/USMK/1EjCv9RIwr/USMK/1EjCv9RIwr/USMK/1EjCv9RIwr/USMK/04fBv+Td2r//////////////////////////////////fz8//r5+f/39fT/8+/v/+7q6f/p4+D/49vZ/9zT0P+IaFn/TyAH/1EjCv9RIwr/USMK/1EjCv9RIwr/USMK/1EjCv9RIwr/USMK/1EjCv9RIwr/USMK/1EjCv9RIwr/TyAH/31aSv+/raf/tqOa/6yVjP+jioD/mX5x/5FzZv+IaFn/f1xN/3hUQ/9wSjj/a0Mw/2Q7Jv9gNCD/WzAZ/1QnD/9RIwr/USMK/1EjCv9RIwr/USMK/1EjCv9RIwr/USMK/1EjCv9RIwr/USMK/1EjCv9RIwr/USMK/1EjCv9RIwr/USML/1EjC/9QIgn/TyAH/04fBv9OHwb/Th8G/04fBv9OIAb/TyAH/08hB/9PIQj/UCEI/1AiCf9QIgn/USMK/1EjCv9RIwr/USMK/1EjCv9RIwr/USMK/1EjCv9RIwr/USMK/1EjCv9RIwr/USMK/1EjCv9RIwr/USMK/1EjCv9RIwr/USMK/1EjCv9RIwr/USMK/1EjCv9RIwr/USMK/1EjCv9RIwr/USMK/1EiCv9RIAj/USEJ/1EjCv9RIwr/USMK/1EjCv9RIwr/USMK/1EjCv9RIwr/USMK/1EjCv9RIwr/USMK/1EjCv9RIwr/USMK/1EjCv9RIwr/USMK/1EjCv9RIwn/TiAG/04fBv9QIQj/USMK/1AiCf9OHwb/Th8G/1AiCf9RIgr/UDAR/09QI/9OaDH/UD8a/1EhCf9RIwr/USMK/1EjCv9RIwr/USMK/1EjCv9RIwr/USMK/1EjCv9RIwr/USMK/1EjCv9RIwr/USMK/1EjCv9RIwr/UCIJ/1svGf+Xe3D/oYd+/3JNOv9PIAb/YTci/5yAdv+bf3X/YDUg/1AlCv9Mj0f/TKFR/0rHZf9PSSD/USEJ/1EjCv9RIwr/USMK/1EjCv9RIwr/USMK/1EjCv9RIwr/USMK/1EjCv9RIwr/USMK/1EjCv9RIwr/USMK/1EjCv9QIQj/ZDsn/+ji4P//////nYR4/0wcA/+cgnb///////7+/v+Ye2//TiwO/0uuWP9PRx//TKJR/05gLP9RIAj/USMK/1EjCv9RIwr/USMK/1EjCv9RIwr/USMK/1EjCv9RIwr/USMK/1EjCv9RIwr/USMK/1EjCv9RIwr/USMK/1AiCf9fNR7/4trX//////+iiH//Wi4X/9jNyf///////////9THw/9aMRr/S49G/0yBPv9Kp1P/T0gf/1EhCf9RIwr/USMK/1EjCv9RIwr/USMK/1EjCv9RIwr/USMK/1EjCv9RIwr/USMK/1EjCv9RIwr/USMK/1EjCv9RIwr/UCIJ/1svGf/b0c7//////6OLgf+FZFb/+/r6/+zn5v/p5OP/+fj4/4JgUf9fRin/YXhI/2FjPP9TJw7/USMK/1EjCv9RIwr/USMK/1EjCv9RIwr/USMK/1EjCv9RIwr/USMK/1EjCv9RIwr/USMK/1EjCv9RIwr/USMK/1EjCv9RIwn/VysU/9TIw///////qpKL/7+up///////tqKb/62Xjv//////vKuj/6mRh//r4uH/x7ay/1ksFv9RIgn/USMK/1EjCv9RIwr/USMK/1EjCv9RIwr/USMK/1EjCv9RIwr/USMK/1EjCv9RIwr/USMK/1EjCv9RIwr/USMK/1EjCv9UJw//zL24///////FtLH/6+Xk//n39/9+XEz/dFA+//Ty8f/r5uT/yLq1///////Qw73/VikR/1EjCv9RIwr/USMK/1EjCv9RIwr/USMK/1EjCv9RIwr/USMK/1EjCv9RIwr/USMK/1EjCv9RIwr/USMK/1EjCv9RIwr/USMK/1IkDf/EtK7///////Hu7f//////1crF/1ouGP9WKRH/y724///////x7e3//////8i4s/9TJQ7/USMK/1EjCv9RIwr/USMK/1EjCv9RIwr/USMK/1EjCv9RIwr/USMK/1EjCv9RIwr/USMK/1EjCv9RIwr/USMK/1EjCv9RIwr/UCIJ/7qnoP////////////////+cgnb/TyAH/04gBv+RdGf//fz9////////////v66m/1EjC/9RIwr/USMK/1EjCv9RIwr/USMK/1EjCv9RIwr/USMK/1EjCv9RIwr/USMK/1EjCv9RIwr/USMK/1EjCv9RIwr/USMK/1EjCv9PIQj/sp2V////////////6uTi/2pCL/9PIQj/UCEI/2M6Jf/j29j///////////+2oZr/UCEJ/1EjCv9RIwr/USMK/1EjCv9RIwr/USMK/1EjCv9RIwr/USMK/1EjCv9RIwr/USMK/1EjCv9RIwr/USMK/1EjCv9RIwr/USMK/08gB/+pkof///////////+6p6D/UiQM/1EjCv9RIwr/UCIJ/6+ZkP///////////62Yjv9PIAf/USMK/1EjCv9RIwr/USMK/1EjCv9RIwr/USMK/1EjCv9RIwr/USMK/1EjCv9RIwr/USMK/1EjCv9RIwr/USMK/1EjCv9RIwr/Th8G/5+Fe///////+Pb1/4FfT/9OIAb/USMK/1EjCv9PIAf/d1NC//Pw7///////o4uA/04fBv9RIwr/USMK/1EjCv9RIwr/USMK/1EjCv9RIwr/USMK/1EjCv9RIwr/USMK/1EjCv9RIwr/USMK/1EjCv9RIwr/USMK/1EjCv9QIQj/bkg1/5d8cP+Nb2H/WCwV/1AiCf9RIwr/USMK/1EjCf9WKRH/imtc/5d9cP9wSjf/UCEI/1EjCv9RIwr/USMK/1EjCv9RIwr/USMK/1EjCv9RIwr/USMK/1EjCv9RIwr/USMK/1EjCv9RIwr/USMK/1EjCv9RIwr/USMK/1EjCv9QIQj/Th8G/04fBv9RIgn/USMK/1EjCv9RIwr/USMK/1EjCv9OIAf/Th8G/1AhCP9RIwr/USMK/1EjCv9RIwr/USMK/1EjCv9RIwr/USMK/1EjCv9RIwr/USMK/1EjCv9RIwr/USMK/1EjCv9RIwr/USMK/1EjCv9RIwr/USMK/1EjCv9RIwr/USMK/1EjCv9RIwr/USMK/1EjCv9RIwr/USMK/1EjCv9RIwr/USMK/1EjCv9RIwr/USMK/1EjCv9RIwr/USMK/1EjCv9RIwr/USMK/1EjCv9RIwr/USMK/1EjCv9RIwr/USMK/1EjCv9RIwr/USMK/1ElC/9RJwz/UScM/1EnDP9RJwz/UScM/1EnDP9RJwz/UScM/1EnDP9RJwz/UScM/1EnDP9RJwz/UScM/1ElC/9RIwr/USMK/1EjCv9RIwr/USMK/1EjCv9RIwr/USMK/1EjCv9RIwr/USMK/1EjCv9RIwr/USMK/1EjCv9RIQn/T1ko/0utVv9LrVb/S61W/0utVv9LrVb/S61W/0utVv9LrVb/S61W/0utVv9LrVb/S61W/0utVv9Lrlb/Tlwq/1EhCf9RIwr/USMK/1EjCv9RIwr/USMK/1EjCv9RIwr/USMK/1EjCv9RIwr/USMK/1EjCv9RIwr/USMK/1EfCP9OcjX/Sex5/0nsev9J7Xr/Se16/0ntev9J7Hn/Sex5/0nref9J63n/Set5/0nqeP9J6nj/Sep4/0nqef9NdTj/UR8I/1EjCv9RIwr/USMK/1EjCv9RIwr/USMK/1EjCv9RIwr/USMK/1EjCv9RIwr/USMK/1EjCv9RIwr/USEJ/09FHf9Ngj//TYtF/0yWSv9MoVD/S6lV/0u0W/9Lu1//SsRj/0rLZ/9K0Wv/Stdu/0nbcP9J4HP/SeR1/01zN/9RIAj/USMK/1EjCv9RIwr/USMK/1EjCv9RIwr/USMK/1EjCv9RIwr/USMK/1EjCv9RIwr/USMK/1EjCv9RIwr/USIJ/1EgCP9RIAn/USIJ/1EkCv9RJQz/USkO/1EsD/9QMRL/UDYV/1A8GP9QRB3/T0oh/09VJv9OXSv/UD0Z/1EiCf9RIwr/USMK/1EjCv9RIwr/USMK/1EjCv9RIwr/USMK/1EjCv9RIwr/USMK/1EjCv9RIwr/USMK/1EjCv9RIwr/USMK/1EjCv9RIwr/USMK/1EjCv9RIwr/USIK/1EiCf9RIgn/USEJ/1EhCf9RIAn/USAI/1EgCP9RIgn/USMK/1EjCv9RIwr/USMK/1EjCv9RIwr/USMK/1EjCv9RIwr/USMK/1EjCv9RIwr/USMK/1EjCv9RIwr/USMK/1EjCv9RIwr/USMK/1EjCv9RIwr/USMK/1EjCv9RIwr/USMK/1EjCv9RIwr/USMK/1EjCv9RIwr/USMK/1EjCv9RIwr/USMK/1EjCv9RIwr/USMK/1EjCv9RIwr/USMK/1EjCv9RIwr/USMK/1EjCv9RIwr/USMK/1EjCv9RIwr/USMK/1EjCv9RIwr/USMK/1EjCv9RIwr/USMK/1EjCv9RIwr/USMK/1EjCv9RIwr/USMK/1EjCv9RIwr/USMK/1EjCv9RIwr/USMK/1EjCv9RIwr/USMK/1EjCv9RIwr/AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA="
#END - Variables To Adjust
##
#

#### DO NOT MODIFY BELOW CODE #####
If ($Action -eq "Add")
{
    #Creates Desktop variable path if needed.  This is incase there is a subfolder on the desktop your putting your shortcut in
    If($(Test-path -path $Desktop -PathType Container) -ne $True)
    {
        Write-host "Created the folder of $desktop"
        New-Item -path $Desktop -ItemType Directory
    }

    #Creates a .lnk file
    If ($ShortcutType -eq ".lnk")
    {
        [byte[]]$Bytes = [convert]::FromBase64String($IconBase64)
        [System.IO.File]::WriteAllBytes($IconPath,$Bytes)
        $shortcutFile = "$Desktop\$ShortcutName$ShortcutType"
        $WScriptShell = New-Object -ComObject WScript.Shell
        $shortcut = $WScriptShell.CreateShortcut($shortcutFile)
        $shortcut.TargetPath = $ShortcutPath
        If ($EnableIcon -eq $True)
        {
            $shortcut.IconLocation = $IconPath
        }
        $shortcut.Save()
        Write-host "Created the .lnk shortcut"
    }
    #Creates a .url file
    If ($ShortcutType -eq ".url")
    {
        [byte[]]$Bytes = [convert]::FromBase64String($IconBase64)
        [System.IO.File]::WriteAllBytes($IconPath,$Bytes)
        $shortcutFile = "$Desktop\$ShortcutName$ShortcutType"
        $WScriptShell = New-Object -ComObject WScript.Shell
        $shortcut = $WScriptShell.CreateShortcut($shortcutFile)
        $shortcut.TargetPath = $ShortcutPath
        $shortcut.Save()
        If ($EnableIcon -eq $True)
        {
            # Append the icon information.
            'IconIndex=0', "IconFile=$IconPath" | 
            Add-Content -LiteralPath $shortcutFile
        }
        Write-host "Created the .url shortcut"
    }
}

If ($Action -eq "Remove") 
{
    #Deletes the shortcut - .lnk or .url
    If($(Test-path -path $Desktop\$ShortcutName$ShortcutType -PathType Leaf) -eq $True)
    {
        Write-host "Removing the shortcut."
        Remove-Item $Desktop\$ShortcutName$ShortcutType -Force -Confirm:$False
    }

    #Cleans up the folder if necessary - Will only remove the folder if the folder is empty and it isn't the root Desktop folder.
    If($(Test-path -path $Desktop -PathType Container) -eq $True)
    {
        If(($(get-childitem "$Desktop").count -eq 0) -and ($($Desktop).EndsWith('\Desktop') -eq $False))
        {
            Write-host "Desktop Sub Folder is Empty, and is not the root Desktop folder, so will delete it."
            Remove-Item $Desktop -Force -Confirm:$False
        }
    }

    #Deletes the icon
    If($(Test-path -path $IconPath -PathType Leaf) -eq $True)
    {
        Write-host "Removing the icon"
        Remove-Item $IconPath -Force -Confirm:$False
    }
}